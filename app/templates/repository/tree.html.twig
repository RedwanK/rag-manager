{% extends 'base.html.twig' %}

{% block title %}Repository tree{% endblock %}

{% block body %}
    <h1>Repository {{ config.repositorySlug }}</h1>
    <p>Last sync: {{ config.lastSyncAt ? config.lastSyncAt|date('Y-m-d H:i') : 'never' }} ({{ config.lastSyncStatus ?? 'n/a' }})</p>

    {% for message in app.flashes('error') %}
        <div>{{ message }}</div>
    {% endfor %}
    {% for message in app.flashes('success') %}
        <div>{{ message }}</div>
    {% endfor %}

    {% if is_granted('ROLE_REVIEWER') %}
        <form method="post" action="{{ path('repository_sync') }}">
            <button type="submit">Trigger sync</button>
        </form>
    {% else %}
        <p>You need reviewer rights to trigger a sync.</p>
    {% endif %}

    <table>
        <thead>
            <tr>
                <th>Path</th>
                <th>Type</th>
                <th>Size</th>
                <th>Last synced</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
        {% for node in nodes %}
            <tr>
                <td>{{ node.path }}</td>
                <td>{{ node.type }}</td>
                <td>{{ node.size ?? '-' }}</td>
                <td>{{ node.lastSyncedAt ? node.lastSyncedAt|date('Y-m-d H:i') : 'never' }}</td>
                <td>{{ node.lastSyncStatus ?? 'n/a' }}</td>
            </tr>
        {% else %}
            <tr><td colspan="5">No cached nodes yet.</td></tr>
        {% endfor %}
        </tbody>
    </table>

    <h2>Recent syncs</h2>
    <ul>
        {% for log in logs %}
            <li>{{ log.startedAt|date('Y-m-d H:i') }} - {{ log.status }} ({{ log.triggeredBy ?? 'unknown' }}) {{ log.message ? ' - ' ~ log.message : '' }}</li>
        {% else %}
            <li>No sync logs yet.</li>
        {% endfor %}
    </ul>
{% endblock %}

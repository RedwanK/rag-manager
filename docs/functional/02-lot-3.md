# Lot 3 – UI Stabilization and Incremental Sync

Third delivery focused on making GitHub sync reliable and incremental while keeping the RAG UI consistent (tree, cached documents list, logs). Goal: avoid data loss, show clear document states, and add useful filters/views for operations.

## Objectives
- Make sync **incremental**: update/create `DocumentNode` without full purge, and handle GitHub deletions without breaking ingestion FKs.
- Fix the **tree**: readable paths (no truncation), correct framing, status filters (indexed/indexable/failed), and a queue button that respects the real document status.
- Enrich the **cached documents list**: extension, ingestion date/status, size (MB) per file.
- Add a **filterable ingestion log view** to diagnose RAG processing.

## Functional scope
- **Incremental sync**
  - Upsert by `path` + `repository_config_id`: if the doc exists, update metadata (`type`, `size`, `lastModified`, `lastSyncedAt`, `lastSyncStatus`) without deleting the row; create it if missing.
  - GitHub deletions: use Doctrine SoftDeletable instead of physical DELETE to preserve `ingestion_queue_item` / `ingestion_log` references.
  - Preserve ingestion status fields: do not reset `status`, ingestion data, or ingestion timestamps during resync.
  - Transaction + sync logs: the overall sync should not abort on one upsert error; log the error, skip to the next document, and avoid partial/dirty data.
  - Performance: avoid massive DELETE/INSERT loops; favor a diff (hash map by path) to detect creates, updates, deletes.

- **Tree display**
  - No lateral truncation: width fits the container, ellipsis only if needed, tooltip with full path.
  - Alignment: tree not clipped left/right; limited horizontal scroll (or wrap) to keep readability.
  - **“Add to queue” button**: visible on indexable files (non-folders) in `unindexed`, `failed`, `download_failed`. For `failed` and `download_failed`, show a “Retry” action that re-enqueues to `queued`. Hidden for `queued`, `processing`, `indexed` with an explanatory tooltip.
  - **Tree filters**: selector (exclude/refine) to show:
    - `Indexed`
    - `Indexable` (eligible, not indexed)
    - `Failed` (`failed` or `download_failed`)
    - `All` (default)

- **Cached documents list**
  - Columns: name + extension, path, ingestion status, ingestion date (last attempt or success), size in MB (2 decimals), and an enqueue action matching the same state rules as the tree card.
  - Default sort: most recent ingestion (desc), with sort on size/name.

- **Filterable ingestion log view**
  - Dedicated screen listing `ingestion_log` with pagination.
  - Combinable filters: level (`info|warning|error`), queue item status (`queued|processing|indexed|failed|download_failed`), date range, document (path search), user who enqueued.
  - Row display: timestamp, level, document, queue item status, message, source (user/system), link to queue item / document.

## Targeted workflows
1) **Sync a repo**  
   - User triggers a sync.  
   - Service compares GitHub list to cache: creates new nodes, updates existing ones, marks missing nodes as soft-deleted via the Doctrine extension.  
   - `ingestion_queue_item` and `ingestion_log` links stay valid. Tree and list reflect changes immediately.

2) **Browse the tree and enqueue**  
   - Tree renders without truncation.  
   - The “Add to queue” button appears only if the file is indexable and not already running/done.  
   - Tree filters let users show only the desired files (indexed, indexable, failed, all).

3) **Review cached documents**  
   - List shows extension, size (MB), status, and ingestion date.  
   - Sorting/filters do not affect sync data; sizes and dates come from the latest ingestion/queue info.

4) **Analyze ingestion logs**  
   - User opens the logs view, filters by level/status/document/date.  
   - Each entry links back to the related queue item or document.

## UX and error rules
- Long paths: ellipsis with tooltip on the full path; click opens the detail (status, size, dates).
- Enqueue button: disabled with explanatory tooltip if status is incompatible; clear error message on failure (quota, max size, disallowed extension).
- Persistent filters: keep the selected filter while navigating the tree.
- Logs: stable pagination; show a message when no results match filters.

## Acceptance criteria
- Sync no longer triggers mass delete/recreate of `DocumentNode` and does not break ingestion FKs.
- After sync, ingestion states and queue/log links remain intact.
- Tree is not horizontally clipped; paths stay readable and filterable.
- “Add to queue” behaves correctly per document status.
- Lists (cached documents, ingestion logs) show the new columns and are filterable.
